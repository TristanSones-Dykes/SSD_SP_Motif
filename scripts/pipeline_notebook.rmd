---
title: "<Species> SRP Pipeline Report"
author: "Tristan Sones-Dykes"
date: "31/07/23"
output: html_document
---

```{r setup, include=FALSE}
library(here)
# grab functions from src
source(here("src", "signal_peptides.r"))
source(here("src", "hydrophobicity.r"))
source(here("src", "motif_analysis.r"))

# define paths
protein_path <- here("data", "Proteins", "SC_first_60.fasta")
RNA_path <- here("data", "RNA", "SC_999.fasta")

# read in AA strings
AA_stringset <- readAAStringSet(protein_path)

# grab protein names
protein_names <- names(AA_stringset)

# run signalP for protein names
signalp_output <- signalp(protein_path)

# run phobius on protein sequences
phobius_output <- r_phobius(protein_path)

# run motif analysis on 5'UTRs
motif_results <- find_motifs(RNA_path)

# combine dfs
combined_df <- signalp_output %>%
    full_join(phobius_output, by = "seqid") %>%
    left_join(motif_results, by = "seqid")
```

### Summary
In this doc we use SignalP and Phobius to find signal peptides and transmembrane regions in protein sequences,
then use the Kyte-Doolittle hydrophobicity scale to find a compound hydrophobicity score
to separate secreted proteins into ones that use the signal recognition particle (SRP) and 
those that don't assuming they form a bimodal distribution. Then use motif analysis to find out if Ssd-1 significantly targets one 
of these groups.

## SignalP and Hydrophobicity 
After running SignalP and Phobius, we can use the Kyte-Doolittle hydrophobicity scale to
find the compound hydrophobicity score for each protein with a signal peptide, then find
the underlying bimodal distribution to categorise the proteins into the two SRP groups.

```{r}
library(mixtools)

# find hydrophobicity scores for each protein
phobius_no_NA <- combined_df %>%
    filter(phobius_type != "OTHER")
signalp_no_NA <- combined_df %>%
    filter(signalp_type != "OTHER")

phobius_df <- data.frame(seqid = character(), phobius_compound_hydro = numeric())
signalp_df <- data.frame(seqid = character(), signalp_compound_hydro = numeric())
for(i in seq_len(nrow(phobius_no_NA))) {
    hydrophobicity_df <- hydropathy_local(AA_stringset[phobius_no_NA$seqid[i]])
    max_hydrophobicity <- hydrophobicity_df %>%
        filter(Position >= phobius_no_NA$phobius_start[i]) %>%
        filter(Position <= phobius_no_NA$phobius_end[i]) %>%
        summarise(max_hydrophobicity = max(WindowHydropathy)) %>%
        pull(max_hydrophobicity)

    window_length <- phobius_no_NA$phobius_end[i] - phobius_no_NA$phobius_start[i] + 1
    compound_hydropathy_score <- max_hydrophobicity * window_length
    phobius_df <- rbind(phobius_df, data.frame(seqid = phobius_no_NA$seqid[i], phobius_compound_hydro = compound_hydropathy_score))
}
for(i in seq_len(nrow(signalp_no_NA))) {
    hydrophobicity_df <- hydropathy_local(AA_stringset[signalp_no_NA$seqid[i]])
    max_hydrophobicity <- hydrophobicity_df %>%
        filter(Position >= signalp_no_NA$signalp_start[i]) %>%
        filter(Position <= signalp_no_NA$signalp_end[i]) %>%
        summarise(max_hydrophobicity = max(WindowHydropathy)) %>%
        pull(max_hydrophobicity)

    window_length <- signalp_no_NA$signalp_end[i] - signalp_no_NA$signalp_start[i] + 1
    compound_hydropathy_score <- max_hydrophobicity * window_length
    signalp_df <- rbind(signalp_df, data.frame(seqid = signalp_no_NA$seqid[i], signalp_compound_hydro = compound_hydropathy_score))
}

combined_df <- combined_df %>%
    full_join(phobius_df, by = "seqid") %>%
    full_join(signalp_df, by = "seqid")

mixed_model <- normalmixEM(phobius_df$phobius_compound_hydro, k = 2)

# find intersection of two normal distributions
intersection <- uniroot(function(x) {
    dnorm(x, mean = mixed_model$mu[1], sd = mixed_model$sigma[1]) - dnorm(x, mean = mixed_model$mu[2], sd = mixed_model$sigma[2])
}, c(min(mixed_model$mu), max(mixed_model$mu)))$root
average <- mean(mixed_model$mu)

# plot distribution of scores with mixture model using ggplot2
# with an overlay of the two normal distributions
ggplot(phobius_df, aes(x = phobius_compound_hydro)) +
    geom_histogram(aes(y = after_stat(density)), bins = 50, fill = "white", colour = "black") + 
    stat_function(fun = dnorm, args = list(mean = mixed_model$mu[1], sd = mixed_model$sigma[1]), colour = "red") +
    stat_function(fun = dnorm, args = list(mean = mixed_model$mu[2], sd = mixed_model$sigma[2]), colour = "green") +
    geom_vline(xintercept = intersection, colour = "blue", linetype = "dashed") +
    geom_vline(xintercept = average, colour = "purple", linetype = "dashed") +
    labs(x = "Compound Hydrophobicity Score", y = "Density", title = "Distribution of Compound Hydrophobicity Scores (Cerevisiae)") +
    theme_bw()
```